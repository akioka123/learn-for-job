# 047
## A/Bテストの実施
### 要件
1. パフォーマンス影響を抑える。
1. 一部コンテンツは最大24時間キャッシュされる。
1. CloudFrontを使用している。

### 対応
CloudFrontにはルーティングの機能はないので、Route53による加重ルーティングでA/Bテストを実施する。
Blue/Greenデプロイにも利用可能

### CloudFront
- 世界に点在するエッジサービス（CDN）。リージョンのコンテンツをキャッシュし、顧客に高速でコンテンツを届ける。
- キャッシュ機能を持つ。キャッシュの無効化にはコストがかかる。

## ロールバックの高速化
### 要件
1. アプリはEC2上で動作している。
1. 負荷分散にELBを使用している。
1. 前回のロールバックには4時間かかっている。
   
### 対応
AWS Opsworks スタックを使用してアプリを再度デプロイし、DeploymentCommandを使用して障害時にロールバックを実施する。

## DBの耐障害性と高可用性
### 要件
1. MySQLを使用する。
2. 耐障害性と高可用性を確保する。

### 対応
複数のAZにインスタンスを作成する。インスタンス間でレプリケーションを有効にする。
マルチAZ配置を有効にする。

## ピーク時のレイテンシーの削減
### 要件
1. ピーク時の応答時間が予想よりも長くなっている。
2. 環境のスケーリングにはAutoScalingを使用している。

### 対応
AutoScalingグループの最大サーバー数を増加する。
ピーク時に応答が長くなっているので、スケールアウトの台数を増加することで対応する。
処理中・処理待ちのリクエスト数などのアプリケーションに関する詳細な情報を含むカスタムメトリクスをCloudWatchにプッシュする。

## AutoScalingのインスタンスの更新
### 要件
1. ELBを備えたAutoScalingグループ
2. 全てのインスタンスを段階的に廃止し、新しいインスタンスに置き換える。

### 対応
古いインスタンスを削除しながら、ELBの背後に追加のAutoScaling設定をアタッチし、新しいインスタンスを段階的に作成する。（スケールアウト時に新しい設定に基づいてインスタンスが作成される。）
スケールインの際に、終了ポリシーによって終了するインスタンスを選択できる。
終了ポリシーでOldestLaunchConfigurationを使用して最も古いインスタンスを削除する。
以前の設定を使用しているインスタンスを廃止する。
終了ポリシーでNewestInstanseを選択すると、最も新しいインスタンスが削除される。

## デプロイ戦略の形式化
### 要件
1. コードリポジトリに標準的なgitコマンドを使用する。
2. 管理ツールはAWSのプラットフォームソリューションを最大限に活用する。
3. デプロイパッケージは変更不可能、Dockerイメージの形式である。

## インフラ管理・AWS環境の構築
### 要件
1. 開発環境には、ALB、EC2、AutoScaling、セキュリティグループ、DynamoDBなどが共通規格としてある。
2. 開発環境の作成を自動化する。
3. 必要なインフラの増加が予想されるので、デプロイしたインフラを簡単に更新できる方法が必要である。
4. CloudFormationを使用する。
   
### 対応
ネストされたスタックを使用して、共通規格となる開発環境を定義する。
ネストされたスタック内でFn:ImportValueを使用することで、作成・出力されるVPCとサブネット値を取得する。CreateChangeSet、ExecuteChangeSetコマンドを使用して、既存の開発環境スタックを更新する。

# 01
## ハイブリットなデプロイの自動化
### 要件
1. アプリは機密性の高い認証情報を含むDBにアクセスする。
2. インスタンスはDBの認証情報にアクセスする。
3. DBの認証情報は保留中、転送中に暗号化されなければならない。

### 対応
AWS・オンプレミス両方にデプロイするためにCodeDeployを使用する。
AWSSystemsManagerのパラメータストアを使用して、安全な文字列を作成使用する。EC2とオンプレミスそれぞれのサーバに関連付けられたロールにIAMポリシーをアタッチする。

## EC2のOSとコアアプリをパッチ更新する
### 要件
1. OSとコアアプリケーションのパッチを更新する。
2. サーバーのパッチレベルに一貫性を持たせる。

### 対応
SystemsManagaerPatchManagerを使用する。
すべてのサーバーにSystemsManagerエージェントをインストールする。
メンテナンスウィンドウ中にパッチ更新を行う。

## IAMポリシーの厳格化（最小限のポリシー）
### 要件
1. Lambda関数によって使用される。
2. 週末にEnvironment：NonProductionでタグ付けされたEC2インスタンスに停止コマンドを発行する。
3. 現在のポリシーは
   ```
    {
        "Version":"2012-10-17",
        "Statement":[
            {
                "Effect":"Allow",
                "Action":"ec2:*",
                "Resource":"*",
            }
        ]
    }
    ```
### 対応
```
{
    "Version":"2012-10-17",
    "Statement":[
        {
            "Effect":"Allow",
            "Action":"ec2:StopInstances",
            "Resource":"arn:aws:ec2:*:*:instance/*",
            "Condition":{
                "StingEquals":{
                    "ec2:ResourceTag/Environment":"NonProduction"
                }
            }
        }
    ]
}
```
- 実行できる操作をインスタンスの停止に限定
- 対象のリソースをEC2インスタンスのみに限定
- 条件指定でEC2インスタンスの環境のタグが「NonProduction」であることを指定

## 効率的で費用対効果の高いログ収集・分析
### 要件
1. 分散したマイクロサービスとオンプレミスのレガシーシステムを統合している。
2. アプリで問題が発生するたびに、問題を特定するログを収集するのに時間がかかりすぎる。

### 対応
CloudWatchLogsを使用する。オンプレミスにはCloudWatchエージェントをインストールする。すべてのログを中央アカウントのS3バケットに保存する。S3をトリガーとするLambda関数を作成し、受信ログを分析して、異常・エラーを自動的に判別する。Athenaを使用して、アドホッククエリを実行する。（ログの照会が可能）
Amazon AthenaはS3に対してクエリを実行することができるようになす。

## コンプライアンス違反のインフラの調査
### 要件
1. AWSのインフラへのタグ付けを標準ルールとしている。
2. ほぼリアルタイムでダッシュボードに表示し、すぐに違反が分かる機能

### 対応
AWS Configでタグ付けと標準ルールの設定、コンプライアンスチェック、違反のフラグ付けを実施する。
構成の変更を記録し、S3に出力する。
S3に出力したデータセットのAmazonQuickSight分析を作成する。

## 最小限ステップでのAWS環境（EC2）のイベントのSlackへの情報連携
### 要件
1. 数千のEC2インスタンスを保有している。
2. チームのコミュニケーションや重要なアップデートにSlackチャンネルを使用している。
3. スケジュールされたすべてのEC2のメンテナンス通知を、会社のSlackチャンネルに送信する。
### 対応
AWS Personal Health Dashboardを使用してリソースのAWSでスケジュールされたEC2のメンテナンスを監視できる。通知のためにCloudWatchと統合し、CloudWatchEventsからLambda関数を呼び出しSlackに通知を送信する。\
AWS Personal Health Dashboardはそこそこ費用がかかる最低で29.00USD

## エラー原因の調査：VPC上のリソースからS3にアクセスできない
### 要件
1. インターネットにアクセスできないVPC上のEC2インスタンス
2. 制限されたS3からオブジェクトをダウンロードする必要がある。
3. オブジェクトにアクセスしようとすると、AccessDeniedエラーが発生する
### 対応（理由）
S3バケットポリシーのエラー、インスタンスにアタッチされているIAMロールがもつIAMポリシーの設定エラー、インスタンスのあるVPCにS3に到達するためのVPCエンドポイントポリシーが不足していることが考えられる。

# 02
## 費用対効果の高い単純なデプロイの自動化：テストと承認
### 要件
1. CodeBuild、CodeDeployを使用したCodePipelineはすでに構築済み
2. 同じコードを使用してパイプラインを次のステージにデプロイする前に、アプリが正常であることを自動テストで確認する。
3. テストが成功した場合でも、デプロイする前に手動承認を実施する。

### 対応
次のステージの前のデプロイの最後にCodeBuildでテストを実施する。CodePipelineにAmazon SNSを使用してチームに通知する手動の承認を追加する。承認後、アプリを次のステージにデプロイするアクションをCodePipelineに追加する。\
テストアクションとしては、オンプレミスでのテストを行うワーカーの作成やLambda関数でのカスタムしたテストなども実施できるが単純でないので不可

---

## 最小限の運用管理による将来の違反を監視するソリューションの構築
### 要件
1. 顧客企業のアプリにおけるセキュリティの脆弱性を評価した。
2. アーキテクチャは「S3」、「ELBの背後にあるAutoScalingグループのEBSストレージを使用するEC2インスタンス」、「RDS MySQL」、「コード内の接続文字列を使用して、RDSと直接通信するLambda関数」
3. セキュリティ上の最大の脅威は「アプリが暗号化して保存する要件をみたしていないこと」


### 対応
SSE暗号化を有効化して、S3、EBS、RDSでのデータの暗号化を実施する。
RDSの認証情報はAmazonSystemsManagerパラメータストアに保持する。S3バケットポリシーで暗号化されていないアップロードは拒否する。
AWSConfigルールで暗号化されていないS3オブジェクトとEBSボリュームをチェックし、RDSが暗号化されていることを確認する。

---

## デプロイの手法：デプロイ中のリソースの全容量の確保とロールバック
### 要件
1. デプロイと管理にはElasticBeanstalkを使用
2. データの永続的な保存にはRDS MySQLを使用
3. デプロイ失敗の場合、影響を最小限に抑える必要がある。
   
### 対応
ElasticBeanstalkを使用して、ElasticBeanstalk環境のプロパティを利用して外部のRDSインスタンスに接続する。Blue/Greenデプロイ用のElasticBeanstalkの機能を利用して新しいリリースを別の環境にデプロイし、CNAMEを交換して、トラフィックを新しいバージョンにリダイレクトする。(URLのスワップ)
※Blue/Greenデプロイはコストが高いため注意が必要。

---

## 費用対効果の高いマイクロサービスの監視
### 要件
1. マイクロサービスは複数のEC2インスタンスで実行される。
2. マイクロサービス全体の1分間あたりの支払回数を知りたい。
3. 1分間当たりの支払回数のメトリクスがしきい値を下回った場合通知を送信する。
### 対応
各インスタンスでCloudWatchエージェントを設定する。成功した支払のトランザクションをアプリケーションログに記録する。CloudWatchアラームを作成し、しきい値を下回った場合にSNSを使用して財務チームに通知する。\
Logsエージェントを使用してCloudWatchLogsにログを集約する。メトリクスフィルターで成功したトランザクションのみにフィルタリングししきい値を下回った場合に通知するアラームを作成できる。

---

## 問題発見時に関係者に通知する方法
### 要件
1. CodePipelineでコードリリースプロセスを実装
2. パイプラインにはCodeDeployが統合されている。
3. アプリのバージョンを各ステージごとに複数のEC2インスタンスにデプロイする。
4. CodeDeployの問題によりパイプラインが失敗する。
5. デプロイ中の監視と通知を改善し、解決時間を短くしたい。

---

### 対応
AmazonEventsBridgeをCodeDeployに統合し、イベントをLambda関数で評価・監視し、Amazon SNSトピックを作成して関係者にデプロイの問題を通知します。
AmazonEventsBridgeをCodeDeployに統合している場合、以下をその後のアクションのターゲットとできる。
- Lambda関数
- KinesisiStreams
- AmazonSQS
- EC2の組み込みAPI
- Amazon SNS

---

## Kibanaへのユーザー単位のアクセス制限
### 要件
1. CloudWatchLogsをES上にインデックス化
2. Kibanaでダッシュボード表示をして実用的な洞察を得ている。

### 対応
- Amazon CognitoでKibanaのユーザー名とパスワードを保護する。
- ユーザー認証とElasticIPを使用して、プロキシサーバを作成し、ESのエンドポイントのアクセスIPを制限する。

Kibanaへのアクセス制御のオプションで、「KibanaのAmazonCognito認証」・「プロキシサーバの有無でIPベースのアクセスポリシー設定」がある。

---

## 異常なネットワークアクティビティの一括監視
### 要件
1. 複数のAWSアカウントが存在する。
2. すべてのアカウントで異常なアカウントやネットワークアクティビティを検出したい。
3. 各アカウントで検出した情報をセキュリティアカウントに集約したい。
4. イベント情報はセキュリティアカウントのS3バケットに保存し、部門のセキュリティ情報イベント管理ツールで監視する。

### 対応
すべてのアカウントでGuardDutyを起動する。
セキュリティアカウントをGuardDutyの管理者とする。AmazonCloudWatchルールを使用して検出結果をAmazonKinesisiDataStreamsに送信する。
KCLアプリケーションを使用してAmazonKinesisiDataStreamsからデータを読み取り、S3バケットに保存する。
